<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integre Estoque | Marcio</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="container">
        
        <% if (!dadosCarregados) { %>
            <div class="upload-screen">
                <div class="app-header">
                    <h3>Bom dia, Marcio</h3>
                    <p>Carregue a planilha para abrir a loja.</p>
                </div>
                
                <form action="/upload" method="POST" enctype="multipart/form-data">
                    
                    <div class="upload-area">
                        <label for="fileInput" class="custom-file-upload">
                            <span class="icon-folder">ðŸ“‚</span>
                            <span class="text-upload">Toque para escolher o arquivo</span>
                        </label>
                        <input type="file" id="fileInput" name="planilha" accept=".xlsx, .xls" required onchange="mostrarNomeArquivo()">
                        
                        <p id="nomeArquivo" class="file-name-display">Nenhum arquivo selecionado</p>
                    </div>

                    <button type="submit" class="btn-main" id="btnCarregar">
                        ABRIR LOJA ðŸš€
                    </button>
                </form>
            </div>
        <% } else { %>

            <div class="app-header">
                <h3>Integre Estoque</h3>
                <p>OlÃ¡, Marcio</p>
                <a href="/reset" class="reset-link">â†» Carregar nova planilha</a>
            </div>

            <div class="search-section">
                <label>Placa ou Modelo (ex: Onix)</label>
                <input type="text" id="inputBusca" placeholder="DIGITE AQUI..." onkeyup="if(event.key === 'Enter') realizarBusca()">
                <button onclick="realizarBusca()" class="btn-main">BUSCAR</button>
            </div>

            <div id="areaResultado" style="display: none;">
                <div class="result-title">Ficha do VeÃ­culo</div>

                <div class="result-card">
                    <div class="row">
                        <div class="field">
                            <span class="label">Marca</span>
                            <span class="value" id="resMarca">--</span>
                        </div>
                        <div class="field right">
                            <span class="label">Modelo</span>
                            <span class="value" id="resModelo">--</span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="field">
                            <span class="label">Ano</span>
                            <span class="value" id="resAno">--</span>
                        </div>
                        <div class="field right">
                            <span class="label">Cor</span>
                            <span class="value" id="resCor">--</span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="field">
                            <span class="label">Quilometragem</span>
                            <span class="value" id="resKm">--</span>
                        </div>
                        <div class="field right">
                            <span class="label">Portas</span>
                            <span class="value" id="resPortas">--</span>
                        </div>
                    </div>

                    <div class="row" style="align-items: center; margin-top: 10px;">
                        <div class="field">
                            <span class="label">LocalizaÃ§Ã£o</span>
                            <span class="store-badge" id="resLoja">--</span>
                        </div>
                        <div class="field right">
                            <span class="label">Placa</span>
                            <span class="value" id="resPlaca" style="font-size: 12px; color:#999;">--</span>
                        </div>
                    </div>

                    <div class="row highlight-row">
                        <div class="field full-center">
                            <span class="label">Valor de Venda</span>
                            <span class="value highlight" id="resValor">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <p id="msgErro" class="error-msg" style="display: none;">Nenhum veÃ­culo encontrado.</p>

        <% } %>
    </div>

    <div id="modalLista" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>VeÃ­culos Encontrados</h4>
                <span onclick="fecharModal()" class="close-btn">&times;</span>
            </div>
            <div id="listaVeiculos" class="lista-items">
                </div>
        </div>
    </div>

    <script>
        // Atualiza o texto quando escolhe o arquivo
        function mostrarNomeArquivo() {
            const input = document.getElementById('fileInput');
            const label = document.getElementById('nomeArquivo');
            if (input.files.length > 0) {
                label.innerText = "Arquivo: " + input.files[0].name;
                label.classList.add('selected');
            } else {
                label.innerText = "Nenhum arquivo selecionado";
                label.classList.remove('selected');
            }
        }

        // Faz a busca no servidor
        async function realizarBusca() {
            const input = document.getElementById('inputBusca');
            const termo = input.value;
            
            if(termo.length < 2) return; // MÃ­nimo 2 letras

            // Reseta visual
            document.getElementById('areaResultado').style.display = 'none';
            document.getElementById('msgErro').style.display = 'none';

            try {
                const response = await fetch('/buscar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ termo })
                });

                const resposta = await response.json();

                if (resposta.type === 'unico') {
                    // Achou Placa exata
                    mostrarFicha(resposta.data);
                } else if (resposta.type === 'lista') {
                    // Achou vÃ¡rios (Modelo)
                    abrirModal(resposta.data);
                } else {
                    // Nada encontrado
                    document.getElementById('msgErro').style.display = 'block';
                }
                
                input.blur(); // Fecha teclado no celular

            } catch (e) {
                console.error("Erro", e);
                alert("Erro ao conectar com o servidor.");
            }
        }

        function mostrarFicha(veiculo) {
            fecharModal();
            const area = document.getElementById('areaResultado');
            
            document.getElementById('resMarca').innerText = veiculo.Marca || '-';
            document.getElementById('resModelo').innerText = veiculo.Modelo || '-';
            document.getElementById('resAno').innerText = veiculo.Ano || '-';
            document.getElementById('resCor').innerText = veiculo.Cor || '-';
            document.getElementById('resKm').innerText = veiculo.Km ? veiculo.Km + ' km' : '-';
            document.getElementById('resPortas').innerText = veiculo.Portas || '-';
            document.getElementById('resLoja').innerText = veiculo.Loja || 'Estoque Geral';
            document.getElementById('resPlaca').innerText = veiculo.Placa || '';
            
            let valor = veiculo.Valor || 0;
            document.getElementById('resValor').innerText = parseFloat(valor).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            
            area.style.display = 'block';
        }

        function abrirModal(lista) {
            const container = document.getElementById('listaVeiculos');
            container.innerHTML = ''; // Limpa anterior

            lista.forEach(carro => {
                const item = document.createElement('div');
                item.className = 'carro-item';
                
                const valorFormatado = parseFloat(carro.Valor || 0).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                
                item.innerHTML = `
                    <div class="carro-info">
                        <span class="carro-modelo">${carro.Modelo}</span>
                        <span class="carro-detalhe">${carro.Cor} â€¢ ${carro.Ano} â€¢ ${carro.Placa}</span>
                    </div>
                    <div class="carro-valor">${valorFormatado}</div>
                `;
                
                item.onclick = () => mostrarFicha(carro);
                container.appendChild(item);
            });

            document.getElementById('modalLista').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('modalLista').style.display = 'none';
        }
    </script>
</body>
</html>